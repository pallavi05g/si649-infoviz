<html>

<head>
  <title>Understanding Projectile Motion</title> <!-- can have a placeholder in title -->
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- CSS, javascript and font -->
  <script src="https://code.jquery.com/jquery-3.1.1.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="https://d3js.org/topojson.v2.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <link rel="stylesheet" href="custom.css">
  <link href="https://fonts.googleapis.com/css?family=Barlow|Spectral+SC:300,400|Cormorant+Garamond" rel="stylesheet">
</head>

<body>
<div class="container">

  <div class="row">
    <div class="col-md-2 col-lg-2"></div>
    <div class="col-md-8 col-lg-8 explanation-part1 title-div">
      <h1 class="viz-title">
        Hate Crimes in USA 2013-2016
      </h1>
      <h4 class="viz-title">
        <!-- style="border-bottom:1px solid #ddd; height: 45px" -->
        By <b>Vizards</b></br>
      </h4>
    </div>
    <div class="col-md-2 col-lg-2"></div>
  </div> <!-- row 1 ends -->

  <div class="row">
    <div class="col-md-2 col-lg-2"></div>
    <div class="col-md-8 col-lg-8 explanation-part1">
      <p>
        Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book.
      </p>
    </div>
    <div class="col-md-2 col-lg-2"></div>
  </div> <!-- row 2 ends -->

  <div class="row">
    <div class="col-md-12 col-lg-12">
      <div class="time-slider-div">
        <label for="time-slider">
          <span>Year</span>
          <input type="range" min="1" max="4" id="time-slider" class="range-slider" value="4" step="1" list="steplist">
          <datalist id="steplist">
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
          </datalist>
          <span id="time-slider-value">2016</span>
        </label>
      </div>
      <div class="viz1_tootlip"></div>
      <div class="viz1_map"></div>
    </div>
  </div> <!-- row 3 ends -->

</div>  <!-- Container ends here -->


<script type="text/javascript">
  //Width and height of map
  var us_state_abbrev = {
    'Alabama': 'AL',
    'Alaska': 'AK',
    'Arizona': 'AZ',
    'Arkansas': 'AR',
    'California': 'CA',
    'Colorado': 'CO',
    'Connecticut': 'CT',
    'Delaware': 'DE',
    'Florida': 'FL',
    'Georgia': 'GA',
    'Hawaii': 'HI',
    'Idaho': 'ID',
    'Illinois': 'IL',
    'Indiana': 'IN',
    'Iowa': 'IA',
    'Kansas': 'KS',
    'Kentucky': 'KY',
    'Louisiana': 'LA',
    'Maine': 'ME',
    'Maryland': 'MD',
    'Massachusetts': 'MA',
    'Michigan': 'MI',
    'Minnesota': 'MN',
    'Mississippi': 'MS',
    'Missouri': 'MO',
    'Montana': 'MT',
    'Nebraska': 'NE',
    'Nevada': 'NV',
    'New Hampshire': 'NH',
    'New Jersey': 'NJ',
    'New Mexico': 'NM',
    'New York': 'NY',
    'North Carolina': 'NC',
    'North Dakota': 'ND',
    'Ohio': 'OH',
    'Oklahoma': 'OK',
    'Oregon': 'OR',
    'Pennsylvania': 'PA',
    'Rhode Island': 'RI',
    'South Carolina': 'SC',
    'South Dakota': 'SD',
    'Tennessee': 'TN',
    'Texas': 'TX',
    'Utah': 'UT',
    'Vermont': 'VT',
    'Virginia': 'VA',
    'Washington': 'WA',
    'West Virginia': 'WV',
    'Wisconsin': 'WI',
    'Wyoming': 'WY',
  }

  var width = d3.select('div.viz1_map')[0][0].scrollWidth;
  var height = 600;

  var projection = d3.geo
                     .albersUsa()
  				           .translate([width/2, height/2])    // translate to center of screen
  				           .scale([1000]);          // scale things down so see entire US

  // Define path generator
  var path = d3.geo
               .path()
  		  	     .projection(projection);

  var color = d3.scale
                .linear()
                .domain([0,1000])
                .interpolate(d3.interpolateHcl)
                .range([d3.rgb("#02447F"), d3.rgb('#A5E9FF')]);

  var svg = d3.select("div.viz1_map")
              .append("svg")
              .attr("width", width)
              .attr("height", height);


  var tip = d3.tip()
              .attr('class', 'd3-tip')
              .html(function(d) {
                  var s = d3.selectAll("input.range-slider");
                  var yr = '';
                  if(s[0][0].value == 1){
                    yr = '13';
                  }
                  if (s[0][0].value == 2) {
                    yr = '14';
                  }
                  if(s[0][0].value == 3){
                    yr = '15';
                  }
                  if (s[0][0].value == 4) {
                    yr = '16';
                  }
                  return "<strong>"+d.properties.name+"</strong></br>"+
                         "<span>Total Hate Crimes : "+d.properties['dataValueTotal'+yr]+"</span>";
              })

  var csv = 'statewise-all-years-categories.csv';
  d3.csv(csv, function(d){
    loadMapData(d);
  });

  // Selecting the slider
  d3.selectAll("input.range-slider").on("input", function() {
        update(+this.value, this.id)
  });

  // This function grabs the value from the slider and updates the map colors
  function update(val, id) {
      var textId = '#' + id + '-value';
      console.log('Value is',val);
      if (val == 1){
        var year = '2013';
        d3.select(textId).text(year);
        d3.csv(csv, function(d){
          updateMapData(d,year.slice(2));
        });
      }
      else if (val == 2){
        var year = '2014';
        d3.select(textId).text(year);
        d3.csv(csv, function(d){
          updateMapData(d,year.slice(2));
        });
      }
      else if (val == 3){
        var year = '2015';
        d3.select(textId).text(year);
        d3.csv(csv, function(d){
          updateMapData(d,year.slice(2));
        });
      }
      else {
        var year = '2016';
        d3.select(textId).text(year);
        d3.csv(csv, function(d){
          updateMapData(d,year.slice(2));
        });
      }
  }

  var loadMapData = function(data) {
        // setting the range of the input data
        color.domain([0,100,200,300,400,500,600,700,800,900,1000]);

        // Load GeoJSON data and merge with states data
        d3.json("us-states.json", function(json) {
            // Loop through each state data value in the .csv file
            for (var i = 0; i < data.length; i++) {

              // Properties we have on state-level : State,Race,Religion,Orientation,Disability,Gender,Identity,Total,Normalization
            	var dataState = data[i].State;

              var dataValueRace13 = data[i].Race13;
              var dataValueReligion13 = data[i].Religion13;
              var dataValueOrientation13 = data[i].SexualOrientation13;
              var dataValueDisablity13 = data[i].Disability13;
              var dataValueGender13 = data[i].Gender13;
              var dataValueGenderIdentity13 = data[i].GenderIdentity13;
              var dataValueTotal13 = Number(data[i].Race13) + Number(data[i].Religion13) + Number(data[i].SexualOrientation13) + Number(data[i].Disability13) + Number(data[i].Gender13) + Number(data[i].GenderIdentity13);

              var dataValueRace14 = data[i].Race14;
              var dataValueReligion14 = data[i].Religion14;
              var dataValueOrientation14 = data[i].SexualOrientation14;
              var dataValueDisablity14 = data[i].Disability14;
              var dataValueGender14 = data[i].Gender14;
              var dataValueGenderIdentity14 = data[i].GenderIdentity14;
              var dataValueTotal14 = Number(data[i].Race14) + Number(data[i].Religion14) + Number(data[i].SexualOrientation14) + Number(data[i].Disability14) + Number(data[i].Gender14) + Number(data[i].GenderIdentity14);

              var dataValueRace15 = data[i].Race15;
              var dataValueReligion15 = data[i].Religion15;
              var dataValueOrientation15 = data[i].SexualOrientation15;
              var dataValueDisablity15 = data[i].Disability15;
              var dataValueGender15 = data[i].Gender15;
              var dataValueGenderIdentity15 = data[i].GenderIdentity15;
              var dataValueTotal15 = Number(data[i].Race15) + Number(data[i].Religion15) + Number(data[i].SexualOrientation15) + Number(data[i].Disability15) + Number(data[i].Gender15) + Number(data[i].GenderIdentity15);

              var dataValueRace16 = data[i].Race16;
              var dataValueReligion16 = data[i].Religion16;
              var dataValueOrientation16 = data[i].SexualOrientation16;
              var dataValueDisablity16 = data[i].Disability16;
              var dataValueGender16 = data[i].Gender16;
              var dataValueGenderIdentity16 = data[i].GenderIdentity16;
              var dataValueTotal16 = Number(data[i].Race16) + Number(data[i].Religion16) + Number(data[i].SexualOrientation16) + Number(data[i].Disability16) + Number(data[i].Gender16) + Number(data[i].GenderIdentity16);

            	// Find the corresponding state inside the GeoJSON
            	for (var j = 0; j < json.features.length; j++)  {
            		  var jsonState = json.features[j].properties.name;
            		  if (dataState == jsonState) {
            		      // Copy the data value into the JSON
                        json.features[j].properties.abbreviation = us_state_abbrev[dataState];

                        json.features[j].properties.dataValueRace13 = dataValueRace13;
                        json.features[j].properties.dataValueReligion13 = dataValueReligion13;
                        json.features[j].properties.dataValueOrientation13 = dataValueOrientation13;
                        json.features[j].properties.dataValueDisablity13 = dataValueDisablity13;
                        json.features[j].properties.dataValueGender13 = dataValueGender13;
                        json.features[j].properties.dataValueGenderIdentity13 = dataValueGenderIdentity13;
                        json.features[j].properties.dataValueTotal13 = dataValueTotal13;

                        json.features[j].properties.dataValueRace14 = dataValueRace14;
                        json.features[j].properties.dataValueReligion14 = dataValueReligion14;
                        json.features[j].properties.dataValueOrientation14 = dataValueOrientation14;
                        json.features[j].properties.dataValueDisablity14 = dataValueDisablity14;
                        json.features[j].properties.dataValueGender14 = dataValueGender14;
                        json.features[j].properties.dataValueGenderIdentity14 = dataValueGenderIdentity14;
                        json.features[j].properties.dataValueTotal14 = dataValueTotal14;

                        json.features[j].properties.dataValueRace15 = dataValueRace15;
                        json.features[j].properties.dataValueReligion15 = dataValueReligion15;
                        json.features[j].properties.dataValueOrientation15 = dataValueOrientation15;
                        json.features[j].properties.dataValueDisablity15 = dataValueDisablity15;
                        json.features[j].properties.dataValueGender15 = dataValueGender15;
                        json.features[j].properties.dataValueGenderIdentity15 = dataValueGenderIdentity15;
                        json.features[j].properties.dataValueTotal15 = dataValueTotal15;

                        json.features[j].properties.dataValueRace16 = dataValueRace16;
                        json.features[j].properties.dataValueReligion16 = dataValueReligion16;
                        json.features[j].properties.dataValueOrientation16 = dataValueOrientation16;
                        json.features[j].properties.dataValueDisablity16 = dataValueDisablity16;
                        json.features[j].properties.dataValueGender16 = dataValueGender16;
                        json.features[j].properties.dataValueGenderIdentity16 = dataValueGenderIdentity16;
                        json.features[j].properties.dataValueTotal16 = dataValueTotal16;

                      break;
            		  }
            	}
            } //outer for loop closed

            // Bind the data to the SVG and create one path per GeoJSON feature
            svg.call(tip);

            svg.selectAll("path")
            	 .data(json.features)
            	 .enter()
            	 .append("path")
            	 .attr("d", path)
               .attr("class", 'pathMap')
            	 .style("stroke", "#eee")
            	 .style("stroke-width", "1")
            	 .style("fill", function(d) {
                	var value = d.properties.dataValueRace13;
                	return color(value);
               })
               .on('mouseover', tip.show)
               .on('mouseout', tip.hide); // style fill's anonymous function closes

            svg.selectAll("text")
               .data(json.features)
               .enter()
               .append("svg:text")
               .text(function(d){ return d.properties.abbreviation; })
               .attr("x", function(d){  return path.centroid(d)[0]; })
               .attr("y", function(d){  return  path.centroid(d)[1];  })
               .attr("text-anchor","middle")
               .attr('font-size','8pt')
               .attr('fill','black');

       }); // Closing d3.json anonymous function.

  }// Closing loadMapData function. Began on line 95.

  var updateMapData = function(d,year){
    var paths = svg.selectAll('path');
    paths.transition()
         .duration(1000)
         .style('fill',function(d,i){
           console.log(d.properties.name,d.properties['dataValueTotal'+year]);
           var value = d.properties['dataValueTotal'+year];
           return color(value);
         });
  }

</script>
</body>
</html>
